#!/usr/bin/env node

var hoax      = require('..')
  , fs        = require('fs')
  , path      = require('path')
  , check     = require('validator').check
  , argv      = require('optimist').boolean(['h', 'help', 'q', 'quiet']).argv
  , args      = argv._;

// Show the usage information if requested
if (argv.h || argv.help || args.length < 3) {
  var fp = path.resolve(__dirname, 'usage.txt')
    , usage = fs.readFileSync(fp, 'utf8');

  process.stdout.write(usage);
  process.exit(1);
}

// Adjust the verbosity if needed
if (argv.q || argv.quiet) {
  hoax.utils.setVerbosity(0);
}

var command = args.shift()
  , uri = args.shift()
  , dir = args.join(' ');

// Verify inputs
try {
  // Check the command
  if (typeof hoax[command] != 'function') {
    throw new Error('invalid command');
  }
  // Check the uri. Errors on failure.
  check(uri).isUrl();
  // Check the directory
  if (!fs.statSync(dir).isDirectory()) {
    throw new Error('invalid directory');
  }
} catch (e) {
  return hoax.utils.error(e.message.toLowerCase());
}

// Run it
hoax[command].call(null, uri, dir, function (err) {
  if (err) {
    var msg = (err.message || JSON.stringify(err)).toLowerCase();
    hoax.utils.error(msg);
  } else {
    hoax.utils.log('done!');
  }
});

